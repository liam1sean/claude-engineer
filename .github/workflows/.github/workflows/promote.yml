name: Promote (Staging -> Production)

on:
  workflow_dispatch:
    inputs:
      image_ref:
        description: "Full image ref from Artifact Registry (tag or digest). Must be the exact image you want promoted to prod."
        required: true
        type: string

env:
  PROJECT_ID: claude-engineer-487504
  REGION: us-central1
  RUNTIME_SA: claude-engineer-ci@claude-engineer-487504.iam.gserviceaccount.com

jobs:
  promote_to_production:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy specified image to Production Cloud Run
        run: |
          gcloud run deploy "claude-engineer-api" \
            --image "${{ inputs.image_ref }}" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --service-account "${{ env.RUNTIME_SA }}" \
            --quiet

      - name: Output Production Service URL
        run: |
          gcloud run services describe "claude-engineer-api" \
            --region "${{ env.REGION }}" \
            --format="value(status.url)"
