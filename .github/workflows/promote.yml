name: Promote (Staging -> Production)

on:
  workflow_dispatch:
    inputs:
      image_ref:
        description: "Full image ref from Artifact Registry (tag or digest). Must be the exact image you want promoted to prod."
        required: true
        type: string

env:
  PROJECT_ID: claude-engineer-487504
  REGION: us-central1
  RUNTIME_SA: claude-engineer-ci@claude-engineer-487504.iam.gserviceaccount.com
  SERVICE_NAME: claude-engineer-api

jobs:
  promote_to_production:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy specified image to Production Cloud Run
        run: |
          gcloud run deploy "${{ env.SERVICE_NAME }}" \
            --image "${{ inputs.image_ref }}" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --service-account "${{ env.RUNTIME_SA }}" \
            --quiet

      - name: Get Production Service URL
        id: url
        run: |
          URL=$(gcloud run services describe "${{ env.SERVICE_NAME }}" \
            --region "${{ env.REGION }}" \
            --format="value(status.url)")
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "$URL"

      - name: Smoke test (GET /)
        run: |
          set -e
          URL="${{ steps.url.outputs.url }}"
          echo "Hitting: $URL"
          # retry loop to allow cold start
          for i in 1 2 3 4 5; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Attempt $i HTTP $code"
            if [ "$code" = "200" ] || [ "$code" = "404" ]; then
              exit 0
            fi
            sleep 5
          done
          echo "Smoke test failed: service did not respond with 200/404"
          exit 1
