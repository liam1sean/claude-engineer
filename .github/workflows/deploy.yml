name: Deploy (Cloud Run)

# Triggered when CI Pipeline completes on main or develop (both jobs must pass)
# Deploys API service first (IAM-protected), then web service (public), then runs smoke test
# workflow_dispatch is retained for emergency manual redeploys

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main, develop]
  workflow_dispatch: {}

concurrency:
  group: deploy-${{ github.event.workflow_run.head_branch || github.ref_name }}
  cancel-in-progress: true

jobs:
  # Gate job: evaluates whether deploy should run
  check:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.evaluate.outputs.should_deploy }}
      branch: ${{ steps.evaluate.outputs.branch }}
      sha: ${{ steps.evaluate.outputs.sha }}
    steps:
      - name: Evaluate deploy conditions
        id: evaluate
        shell: bash
        run: |
          SHOULD_DEPLOY="false"
          BRANCH=""
          SHA=""

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SHOULD_DEPLOY="true"
            BRANCH="${GITHUB_REF_NAME}"
            SHA="${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            SHA="${{ github.event.workflow_run.head_sha }}"
            CONCLUSION="${{ github.event.workflow_run.conclusion }}"
            if [[ "$CONCLUSION" == "success" && ( "$BRANCH" == "main" || "$BRANCH" == "develop" ) ]]; then
              SHOULD_DEPLOY="true"
            fi
          fi

          echo "should_deploy=${SHOULD_DEPLOY}" >> "$GITHUB_OUTPUT"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "sha=${SHA}" >> "$GITHUB_OUTPUT"

  deploy:
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.should_deploy == 'true'

    env:
      PROJECT_ID: claude-engineer-487504
      REGION: us-central1
      AR_HOST: us-central1-docker.pkg.dev
      AR_REPO: claude-engineer-docker
      RUNTIME_SA: claude-engineer-ci@claude-engineer-487504.iam.gserviceaccount.com

    steps:
      # Checkout the commit to deploy
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check.outputs.sha }}

      # Resolve service names and image URIs based on branch
      - name: Resolve deploy context
        id: ctx
        shell: bash
        run: |
          BRANCH="${{ needs.check.outputs.branch }}"
          SHA="${{ needs.check.outputs.sha }}"

          if [[ "$BRANCH" == "develop" ]]; then
            API_SERVICE="claude-engineer-api-staging"
            WEB_SERVICE="claude-engineer-web-staging"
          elif [[ "$BRANCH" == "main" ]]; then
            API_SERVICE="claude-engineer-api"
            WEB_SERVICE="claude-engineer-web"
          else
            echo "Unsupported branch for deploy: $BRANCH"
            exit 1
          fi

          BASE="${{ env.AR_HOST }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}"

          echo "api_service=$API_SERVICE" >> "$GITHUB_OUTPUT"
          echo "web_service=$WEB_SERVICE" >> "$GITHUB_OUTPUT"
          echo "api_image=${BASE}/claude-engineer-api:${SHA}" >> "$GITHUB_OUTPUT"
          echo "web_image=${BASE}/claude-engineer-web:${SHA}" >> "$GITHUB_OUTPUT"

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # Deploy API service (IAM-protected)
      - name: Deploy API service
        shell: bash
        run: |
          gcloud run deploy "${{ steps.ctx.outputs.api_service }}" \
            --image "${{ steps.ctx.outputs.api_image }}" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --service-account "${{ env.RUNTIME_SA }}" \
            --no-allow-unauthenticated \
            --quiet

      # Get API URL for web service
      - name: Get API service URL
        id: api_url
        shell: bash
        run: |
          URL=$(gcloud run services describe "${{ steps.ctx.outputs.api_service }}" \
            --region "${{ env.REGION }}" \
            --format="value(status.url)")
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      # Deploy Web service (public)
      - name: Deploy Web service
        shell: bash
        run: |
          gcloud run deploy "${{ steps.ctx.outputs.web_service }}" \
            --image "${{ steps.ctx.outputs.web_image }}" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --service-account "${{ env.RUNTIME_SA }}" \
            --allow-unauthenticated \
            --set-env-vars "API_CLAUDE_URL=${{ steps.api_url.outputs.url }}" \
            --quiet

      # Get Web service URL
      - name: Get Web service URL
        id: web_url
        shell: bash
        run: |
          URL=$(gcloud run services describe "${{ steps.ctx.outputs.web_service }}" \
            --region "${{ env.REGION }}" \
            --format="value(status.url)")
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      # Smoke test against API service
      - name: Setup Node.js for smoke test
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run smoke test
        run: node tools/smoke.js
        env:
          WEB_SERVICE_URL: ${{ steps.api_url.outputs.url }}     # run smoke test against API
          SERVICE_API_KEY: ${{ secrets.SERVICE_API_KEY }}      # optional x-api-key auth
        timeout-minutes: 3